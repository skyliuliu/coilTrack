# coilTrack

## 1. 简介
&emsp;&emsp;基于python3的线圈阵列磁定位方法，使用外置的线圈阵列发射AC交变磁场，在胶囊内置线圈中产生感应信号，实现对胶囊的定位。

## 2. 硬件
### 2.1 发射线圈
&emsp;&emsp;多个线圈呈阵列分布
- n1 = 205  ``` 发射线圈匝数```
- nr1 = 9   ``` 发射线圈层数```
- r1 = 5    ``` 发射线圈内半径【mm】```
- d1 = 0.6  ``` 发射线圈线径【mm】```
#### 线圈排列
|编号| 坐标/mm |
|:-------:|:--------:|
|0|(-150, 150, 0)|
|1| (-50, 150, 0) |
|2| (50, 150, 0) |
|3|(150, 150, 0)|
|4|(-150, 50, 0)|
|5| (-50, 50, 0)|
|6| (50, 50, 0)|
|7| (150, 50, 0)|
|8| (-150, -50, 0)|
|9| (-50, -50, 0)|
|10| (50, -50, 0)|
|11| (150, -50, 0)|
|12| (-150, -150, 0)|
|13| (-50, -150, 0)|
|14| (50, -150, 0)|
|15| (150, -150, 0)|

### 2.2接收线圈
&emsp;&emsp;一个单轴的空心线圈
- n2 = 100   ``` 接收线圈匝数```
- nr2 = 2    ``` 接收线圈层数```
- r2 = 2.5   ``` 接收线圈内半径【mm】```
- d2 = 0.05  ``` 接收线圈线径【mm】```

### 2.3 驱动电路：
&emsp;&emsp;发射线圈依次工作，通过串口下发命令控制电路的启动和高低电平的时间。
- freq = 5000   ``` 工作频率【Hz】```

### 2.4 采样电路
&emsp;&emsp;提取接收线圈的感应电压。  
&emsp;&emsp;当前采用谐振电路拾取接收线圈的感应电压，然后两级运算放大器进行放大，总共放大1000倍
，然后通过ADC采样转换为数字信号，由串口传输至PC端。

### 2.5 相关参数计算
$$
A=\mu_0N_1N_2S_1S_2fI=18347893786 (I=2A)
$$

## 3. 代码组成

| 文件名              | 简介                           |
|:-------------------|:-------------------------------|
|agreement.py        | 读取接收端的串口通讯协议 |
| calculatorLM.py    | 使用LM算法实现的定位方法      |
| calculatorUKF.py   | 使用UKF算法实现的定位方法     |
| predictorViewer.py | 绘图工具，包括定位过程，误差分布等 |
| readData.py        | 实时读取接收端的数据 |
| coilArray.py       | 定义发射线圈和接收线圈参数的类    |
| dataTool.py        | 时域数据处理函数，包含寻峰、FFT、绘图等|
| Lie.py             | 李代数的实现 |
| se3LM.py           | 基于李代数+LM算法实现的定位方法 |
| predictor.py       | 定位程序的主文件，calculatorLM + se3LM的集成 |
| data.csv           | 采集的时域数据 |
| measureData.csv    | 每个线圈产生的信号幅值 |
| requirements.txt    | 依赖包及版本号 |

## 4. 软件安装方法
- python >= 3.8
- pip工具升级到最新版本：```python3 -m pip install --upgrade pip```
- 依赖包的版本要求如requirements.txt所示，或者用最新版本
- 依赖包安装方法：pip install -r requirements.txt

## 5. 使用方法
#### 5.1 读取实时数据
&emsp;&emsp;运行```readData.py```，出现UI界面后通过串口工具向发射端发送启动命令
"![实时采集数据界面](https://incode.sibionics.com/magLoc/coiltrack/-/raw/main/pic/readData.PNG?inline=false)"

#### 5.2 实时定位
&emsp;&emsp;运行```predictor.py```，出现UI界面后通过串口工具向发射端发送启动命令
"![定位程序界面](https://incode.sibionics.com/magLoc/coiltrack/-/raw/main/pic/track.png?inline=false)"